@model RestaurantWeb.Models.ViewModels.BackupIndexVm

@{
    ViewData["Title"] = "Veritabanı Backup";
}

<div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="mb-0">Veritabanı Backup</h2>

    <form asp-action="Create" method="post">
        @Html.AntiForgeryToken()
        <button class="btn btn-primary" type="submit">
            Backup Al
        </button>
    </form>
</div>

<div class="alert alert-warning">
    <div class="fw-semibold">Notlar</div>
    <ul class="mb-0">
        <li>Backup, sunucuda <code>App_Data/Backups</code> altında saklanır.</li>
        <li>Bu işlem <code>pg_dump</code> gerektirir (appsettings.json: <code>Backup:PgDumpPath</code>).</li>
    </ul>
</div>

@if (Model.Items == null || Model.Items.Count == 0)
{
    <div class="text-muted">Kayıt yok.</div>
}
else
{
    <div class="table-responsive">
        <table class="table table-sm table-striped align-middle">
            <thead>
                <tr>
                    <th>Dosya</th>
                    <th class="text-end">Boyut</th>
                    <th>Oluşturma</th>
                    <th class="text-end">İşlem</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var b in Model.Items)
                {
                    <tr>
                        <td class="text-break">@b.FileName</td>
                        <td class="text-end">@FormatBytes(b.SizeBytes)</td>
                        <td>@b.CreatedAt.ToString("yyyy-MM-dd HH:mm:ss")</td>
                        <td class="text-end">
                            <a class="btn btn-sm btn-outline-success"
                               asp-action="Download"
                               asp-route-fileName="@b.FileName">
                                İndir
                            </a>

                            <form asp-action="Delete" method="post" class="d-inline">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="fileName" value="@b.FileName" />
                                <button class="btn btn-sm btn-outline-danger"
                                        type="submit"
                                        onclick="return confirm('Bu backup silinsin mi?');">
                                    Sil
                                </button>
                            </form>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@functions {
    private static string FormatBytes(long bytes)
    {
        if (bytes < 1024) return $"{bytes} B";
        double kb = bytes / 1024.0;
        if (kb < 1024) return $"{kb:0.##} KB";
        double mb = kb / 1024.0;
        if (mb < 1024) return $"{mb:0.##} MB";
        double gb = mb / 1024.0;
        return $"{gb:0.##} GB";
    }
}
