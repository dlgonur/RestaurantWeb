@{
    ViewData["Title"] = "Mutfak";
}

<h2>Mutfak - Bekleyen Siparişler</h2>

@Html.AntiForgeryToken()

<div id="pendingContainer" class="mt-3">
    <div class="text-muted">Yükleniyor...</div>
</div>

@section Scripts {
    <script>
        (() => {
            const container = document.getElementById("pendingContainer");
            const tokenInput = document.querySelector('input[name="__RequestVerificationToken"]');
            const antiForgeryToken = tokenInput ? tokenInput.value : "";

            async function loadPending() {
                const res = await fetch('/Mutfak/PendingPartial');
                if (!res.ok) { container.innerHTML = '<div class="text-danger">Yüklenemedi.</div>'; return; }
                container.innerHTML = await res.text();
            }

            // Kalem durum butonları (event delegation)
            container.addEventListener('click', async (e) => {
                const btn = e.target.closest('[data-kalem][data-durum]');
                if (!btn) return;

                const kalemId = parseInt(btn.getAttribute('data-kalem'), 10);
                const durum = parseInt(btn.getAttribute('data-durum'), 10);

                const res = await fetch('/Mutfak/SetItemStatus', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': antiForgeryToken
                    },
                    body: JSON.stringify({ kalemId, durum })
                });

                if (res.ok) await loadPending();
            });

            loadPending();
            setInterval(loadPending, 15000);
        })();
    </script>
}
